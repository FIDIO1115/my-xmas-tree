<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Magic 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        #main-title { 
            position: absolute; top: 40px; left: 0; width: 100%; text-align: center; 
            z-index: 500; opacity: 0; transition: opacity 1s ease; 
            font-family: 'Great Vibes', cursive; font-size: 3.5rem;
            background: linear-gradient(to bottom, #ffd700 20%, #fffacd 50%, #ffaa00 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7));
        }

        /* åˆå§‹å•Ÿå‹•ç•«é¢ */
        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle, #1a0000 0%, #000 100%); 
            z-index: 2000; display: flex; flex-direction: column; justify-content: center; 
            align-items: center; color: #fff; 
        }
        #btn-start { 
            padding: 18px 60px; font-size: 22px; background: linear-gradient(90deg, #ff4d4d, #b30000); 
            border: none; border-radius: 40px; color: #fff; font-weight: bold; cursor: pointer; 
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4); margin-top: 20px; 
        }

        /* ç¦®ç‰©ç›’æ¨£å¼ */
        #gift-box-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 150px; height: 150px; z-index: 1900; cursor: pointer;
            display: none; transition: all 0.5s ease;
        }
        .gift-box {
            width: 100%; height: 100%; background: #d42426; position: relative;
            border-radius: 10px; box-shadow: 0 0 30px rgba(255,0,0,0.5);
            animation: shake 0.5s infinite;
        }
        .gift-box::after { content: 'ğŸ'; font-size: 80px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }

        /* è† æ²ç‰†ä½ˆå±€ */
        #wish-wall { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1800; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            opacity: 0; transition: opacity 0.8s ease; backdrop-filter: blur(20px);
        }
        #wish-wall.active { display: flex; opacity: 1; }
        #wish-text { font-family: 'Ma Shan Zheng', cursive; font-size: 2.5rem; color: #ffd700; text-align: center; margin: 40px 0; z-index: 10; }

        .film-container { width: 100%; overflow: hidden; position: relative; height: 180px; }
        .film-strip { display: flex; width: max-content; animation: moveStrip 60s linear infinite; }
        .film-strip img { height: 150px; width: auto; margin: 0 10px; border: 5px solid #fff; }

        @keyframes moveStrip { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        #input_video { position: absolute; bottom: 10px; right: 10px; width: 100px; height: 75px; transform: scaleX(-1); border-radius: 8px; opacity: 0.5; z-index: 1000; }
        .hint { position: absolute; bottom: 15px; width: 100%; text-align: center; color: #fff; font-size: 13px; z-index: 1000; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
    <div id="main-title">Snowman Magic 2025</div>
    
    <div id="start-screen">
        <h1 style="font-family: 'Great Vibes'; font-size: 3rem; color: #ffd700;">Winter Memories</h1>
        <button id="btn-start">é–‹å•Ÿè–èª•é­”æ³• âœ¨</button>
        <p id="loading-msg" style="margin-top:15px; color:#888;">æ­£åœ¨æº–å‚™é­”æ³•ä¸­...</p>
    </div>

    <div id="gift-box-container">
        <div class="gift-box"></div>
        <p style="color: gold; text-align: center; font-weight: bold; margin-top: 10px;">é»æ“Šé–‹å•Ÿï¼</p>
    </div>

    <div id="wish-wall">
        <div class="film-container"><div class="film-strip" id="strip-top"></div></div>
        <div id="wish-text">åƒä»£ ç¥ä½ è–èª•å¿«æ¨‚<br><span style="font-size: 1.2rem;">é¡˜é€™ä»½æº«æš–æ°¸é é™ªä¼´è‘—ä½ </span></div>
        <div class="film-container"><div class="film-strip" id="strip-bottom"></div></div>
    </div>

    <video id="input_video"></video>
    <div class="hint" id="hint-text"></div>

    <script>
        const PHOTO_COUNT = 77;
        let scene, camera, renderer, treeGroup, particleSystem, photoMeshes = [], loadedImages = [];
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const state = { giftShown: false, explosion: 0 };

        // ä½¿ç”¨æ›´ç©©å®šçš„éŸ³æ¨‚é€£çµ (Sia - Snowman)
        const bgm = new Audio("https://actions.google.com/é–‹æºéŸ³æ¨‚/Sia_Snowman_Sample.mp3"); // æ­¤è™•å»ºè­°æ›´æ›ç‚ºæ‚¨æ“æœ‰çš„æœ‰æ•ˆ mp3 é€£çµ
        bgm.loop = true;

        // é è¼‰å…¥åœ–ç‰‡
        async function preload() {
            let loaded = 0;
            const topStrip = document.getElementById('strip-top');
            const bottomStrip = document.getElementById('strip-bottom');

            for (let i = 1; i <= PHOTO_COUNT; i++) {
                const img = new Image();
                img.src = `${i}.jpg`;
                img.onload = () => {
                    loadedImages.push(img);
                    loaded++;
                    document.getElementById('loading-msg').innerText = `å·²è¼‰å…¥è¨˜æ†¶ (${loaded}/${PHOTO_COUNT})`;
                    
                    // å‹•æ…‹åŠ å…¥è† æ²
                    const clone1 = img.cloneNode();
                    const clone2 = img.cloneNode();
                    topStrip.appendChild(clone1);
                    bottomStrip.insertBefore(clone2, bottomStrip.firstChild);
                    
                    if (loaded === 10) { // è¼‰å…¥ 10 å¼µå¾Œå…è¨±é–‹å§‹ï¼Œå…¶é¤˜èƒŒæ™¯è¼‰å…¥
                        document.getElementById('btn-start').style.display = 'block';
                    }
                };
                img.onerror = () => { loaded++; };
            }
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 90);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            // ç°¡å–®ç²’å­æ¨¹
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<8000; i++) {
                const y = Math.random() * 70;
                const r = (1 - y/70) * 25;
                const a = Math.random() * Math.PI * 2;
                pos.push(Math.cos(a)*r, y - 10, Math.sin(a)*r);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            particleSystem = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0x228b22, size: 0.5 }));
            treeGroup.add(particleSystem);

            // åŠ å…¥çƒé«”ç…§ç‰‡
            loadedImages.forEach((img, i) => {
                const tex = new THREE.CanvasTexture(img);
                const mat = new THREE.MeshBasicMaterial({ map: tex });
                const mesh = new THREE.Mesh(new THREE.SphereGeometry(3, 16, 16), mat);
                const y = Math.random() * 60;
                const r = (1 - y/70) * 30 + 5;
                const a = Math.random() * Math.PI * 2;
                mesh.position.set(Math.cos(a)*r, y-10, Math.sin(a)*r);
                treeGroup.add(mesh);
                photoMeshes.push(mesh);
            });

            render();
        }

        function render() {
            requestAnimationFrame(render);
            treeGroup.rotation.y += 0.005;
            photoMeshes.forEach(m => m.lookAt(camera.position));
            renderer.render(scene, camera);
        }

        function triggerGift() {
            if(state.giftShown) return;
            state.giftShown = true;
            const container = document.getElementById('gift-box-container');
            container.style.display = 'block';
            if(!isMobile) setTimeout(openGift, 2000); 
        }

        function openGift() {
            document.getElementById('gift-box-container').style.display = 'none';
            const wall = document.getElementById('wish-wall');
            wall.style.display = 'flex';
            setTimeout(() => wall.classList.add('active'), 50);
            
            // è¤‡è£½è† æ²å…§å®¹ä»¥å¯¦ç¾ç„¡ç¸«å¾ªç’°
            document.getElementById('strip-top').innerHTML += document.getElementById('strip-top').innerHTML;
            document.getElementById('strip-bottom').innerHTML += document.getElementById('strip-bottom').innerHTML;
        }

        // æ‰‹å‹¢è¾¨è­˜
        function setupHands() {
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });
            hands.onResults(results => {
                if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
                    const lm = results.multiHandLandmarks[0];
                    const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
                    if (dist > 0.2) triggerGift(); // ç°¡å–®åµæ¸¬å¼µé–‹æ‰‹æŒè§¸ç™¼
                }
            });
            const cameraFeed = new Camera(document.getElementById('input_video'), {
                onFrame: async () => { await hands.send({image: document.getElementById('input_video')}); },
                width: 320, height: 240
            });
            cameraFeed.start();
        }

        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-title').style.opacity = 1;
            bgm.play().catch(() => console.log("ç­‰å¾…ç”¨æˆ¶äº¤äº’å•Ÿå‹•éŸ³æ¨‚"));
            initThree();
            if(!isMobile) setupHands();
            else {
                // æ‰‹æ©Ÿç‰ˆé€£é»å…©ä¸‹è¢å¹•
                let last = 0;
                window.addEventListener('touchstart', () => {
                    let now = Date.now();
                    if(now - last < 300) triggerGift();
                    last = now;
                });
            }
        });

        document.getElementById('gift-box-container').addEventListener('click', openGift);

        preload();
    </script>
</body>
</html>