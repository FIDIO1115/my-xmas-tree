<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christmas Magic 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        /* æ¨™é¡Œ */
        #main-title { 
            position: absolute; top: 40px; left: 0; width: 100%; text-align: center; 
            z-index: 500; opacity: 0; transition: opacity 1s ease; 
            font-family: 'Great Vibes', cursive; font-size: 3.5rem;
            background: linear-gradient(to bottom, #ffd700 20%, #fffacd 50%, #ffaa00 80%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7));
        }

        /* å•Ÿå‹•ç•«é¢ */
        #start-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle, #1a0000 0%, #000 100%); 
            z-index: 2000; display: flex; flex-direction: column; justify-content: center; 
            align-items: center; color: #fff; 
        }
        #btn-start { 
            padding: 18px 60px; font-size: 22px; background: linear-gradient(90deg, #ff4d4d, #b30000); 
            border: none; border-radius: 40px; color: #fff; font-weight: bold; cursor: pointer; 
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4); margin-top: 20px;
        }

        /* ç¦®ç‰©ç›’ï¼šæ”¹ç‚ºç°¡å–®åœ–ç‰‡/æ–‡å­—è§¸ç™¼ï¼Œæœ€ç©© */
        #gift-trigger {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 1000; cursor: pointer; display: none; text-align: center;
        }
        .gift-icon { font-size: 60px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* é›»å½±è† æ²ç‰† */
        #wish-wall { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 1800; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            opacity: 0; transition: opacity 0.8s ease; backdrop-filter: blur(20px);
        }
        #wish-wall.active { display: flex; opacity: 1; }
        
        #wish-text { 
            font-family: 'Ma Shan Zheng', cursive; font-size: 2.5rem; color: #ffd700; 
            text-align: center; margin: 30px 0; z-index: 10; text-shadow: 0 0 15px #ffaa00;
        }

        .film-container { width: 100%; overflow: hidden; position: relative; height: 160px; background: rgba(255,255,255,0.05); }
        .film-strip { display: flex; width: max-content; animation: moveStrip 60s linear infinite; }
        .film-strip img { height: 140px; width: auto; margin: 0 10px; border: 4px solid #fff; border-radius: 2px; }

        @keyframes moveStrip { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        .hint { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #666; font-size: 12px; z-index: 500; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="main-title">Snowman Magic 2025</div>
    
    <div id="start-screen">
        <h1 style="font-family: 'Great Vibes'; font-size: 3rem; color: #ffd700;">Christmas Memories</h1>
        <button id="btn-start">é–‹å•Ÿé­”æ³•</button>
        <p id="loading-msg" style="margin-top:15px; color:#666;">Ready to start...</p>
    </div>

    <div id="gift-trigger">
        <div class="gift-icon">ğŸ</div>
        <div style="color: gold; font-weight: bold;">é»æ“Šé–‹å•Ÿé©šå–œ</div>
    </div>

    <div id="wish-wall">
        <div class="film-container"><div class="film-strip" id="strip-top"></div></div>
        <div id="wish-text">åƒä»£ ç¥ä½ è–èª•å¿«æ¨‚<br><span style="font-size: 1.2rem; opacity: 0.8;">é¡˜é€™ä»½æº«æš–æ°¸é é™ªä¼´è‘—ä½ </span></div>
        <div class="film-container"><div class="film-strip" id="strip-bottom"></div></div>
    </div>

    <div class="hint">æ‰‹æ©Ÿç”¨æˆ¶ï¼šé»æ“Šç¦®ç‰©ç›’é–‹å•Ÿé©šå–œç‰†</div>

    <script>
        const ALL_PHOTOS_COUNT = 77;
        const TREE_PHOTOS_COUNT = 30; // æ¨¹ä¸Šåªæ”¾30å¼µ
        let scene, camera, renderer, treeGroup, photoMeshes = [], loadedImages = [];

        // éŸ³æ¨‚è¨­å®š
        const bgm = new Audio("https://actions.google.com/é–‹æºéŸ³æ¨‚/Sia_Snowman_Sample.mp3"); 
        bgm.loop = true;

        // å•Ÿå‹•æµç¨‹
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-title').style.opacity = 1;
            document.getElementById('gift-trigger').style.display = 'block';
            
            try { bgm.play(); } catch(e) {}
            
            initThree();
            loadAllResources();
        });

        // æ ¸å¿ƒ 3D åˆå§‹åŒ–
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 30, 100);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);
            
            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            // å»ºç«‹ç¶ è‰²ç²’å­è–èª•æ¨¹
            const pointsCount = 6000;
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<pointsCount; i++) {
                const y = Math.random() * 75;
                const r = (1 - y/75) * 28;
                const a = Math.random() * Math.PI * 2;
                pos.push(Math.cos(a)*r, y - 15, Math.sin(a)*r);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const pMat = new THREE.PointsMaterial({ color: 0x1a472a, size: 0.6 });
            treeGroup.add(new THREE.Points(geo, pMat));

            animate();
        }

        // è¼‰å…¥ç…§ç‰‡è³‡æº
        function loadAllResources() {
            const topStrip = document.getElementById('strip-top');
            const bottomStrip = document.getElementById('strip-bottom');

            for (let i = 1; i <= ALL_PHOTOS_COUNT; i++) {
                const img = new Image();
                img.src = `${i}.jpg`;
                img.onload = () => {
                    loadedImages.push(img);

                    // 1. å¦‚æœæ˜¯å‰30å¼µï¼Œæ”¾ä¸Šæ¨¹
                    if (loadedImages.length <= TREE_PHOTOS_COUNT) {
                        addPhotoToTree(img);
                    }

                    // 2. åŠ å…¥è† æ²ç‰† (å…¨éƒ¨ 77 å¼µ)
                    const c1 = img.cloneNode();
                    const c2 = img.cloneNode();
                    topStrip.appendChild(c1);
                    bottomStrip.appendChild(c2);

                    // 3. è™•ç†ç„¡é™å¾ªç’° (ç•¶è¼‰å…¥åˆ°æœ€å¾Œä¸€å¼µæ™‚)
                    if (loadedImages.length === ALL_PHOTOS_COUNT) {
                        duplicateStrips();
                    }
                };
            }
        }

        function addPhotoToTree(img) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.beginPath(); ctx.arc(64, 64, 64, 0, Math.PI*2); ctx.clip();
            ctx.drawImage(img, 0, 0, 128, 128);
            
            const tex = new THREE.CanvasTexture(canvas);
            const mesh = new THREE.Mesh(
                new THREE.SphereGeometry(3, 16, 16),
                new THREE.MeshBasicMaterial({ map: tex })
            );
            
            const y = Math.random() * 65;
            const r = (1 - y/75) * 30 + 2;
            const a = Math.random() * Math.PI * 2;
            mesh.position.set(Math.cos(a)*r, y-15, Math.sin(a)*r);
            treeGroup.add(mesh);
            photoMeshes.push(mesh);
        }

        function duplicateStrips() {
            const t = document.getElementById('strip-top');
            const b = document.getElementById('strip-bottom');
            t.innerHTML += t.innerHTML; // è¤‡è£½ä¸€ä»½é”æˆç„¡ç¸«
            b.innerHTML += b.innerHTML;
        }

        function animate() {
            requestAnimationFrame(animate);
            treeGroup.rotation.y += 0.005;
            photoMeshes.forEach(m => m.lookAt(camera.position));
            renderer.render(scene, camera);
        }

        // é–‹å•Ÿé©šå–œ
        document.getElementById('gift-trigger').addEventListener('click', () => {
            const wall = document.getElementById('wish-wall');
            wall.style.display = 'flex';
            setTimeout(() => wall.classList.add('active'), 50);
            document.getElementById('gift-trigger').style.display = 'none';
        });

        // é»æ“Šç‰†é¢é—œé–‰
        document.getElementById('wish-wall').addEventListener('click', (e) => {
            if(e.target.id === 'wish-wall' || e.target.id === 'wish-text') {
                document.getElementById('wish-wall').classList.remove('active');
                setTimeout(() => document.getElementById('wish-wall').style.display = 'none', 800);
                document.getElementById('gift-trigger').style.display = 'block';
            }
        });

        // çª—å£ç¸®æ”¾è™•ç†
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>